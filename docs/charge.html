<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EV Tycoon Balanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #0f172a; 
            color: #e2e8f0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        canvas { 
            width: 100%;
            height: auto;
            background-color: #1e293b; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); 
            display: block;
        }

        .stat-card { 
            background: #334155; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px solid #475569;
            text-align: center; 
        }

        .btn { transition: all 0.1s; border-width: 1px; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.4; filter: grayscale(100%); cursor: not-allowed; }

        .float-text {
            position: absolute;
            font-weight: 800;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            z-index: 50;
            text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50px) scale(1); opacity: 0; }
        }

        /* èƒ½é‡æ¡ */
        .power-bar-bg { background: #475569; height: 6px; border-radius: 3px; overflow: hidden; display: flex; }
        .power-bar-seg { height: 100%; transition: width 0.3s; }
        
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-2 max-w-md mx-auto md:max-w-4xl">

    <!-- é¡¶éƒ¨æ•°æ®æ  -->
    <div class="grid grid-cols-3 gap-2 mb-2 w-full">
        <!-- èµ„é‡‘ -->
        <div class="stat-card border-t-2 border-green-500">
            <span class="text-[10px] text-gray-400">å½“å‰èµ„é‡‘</span>
            <div class="text-xl font-mono text-green-400 font-bold" id="ui-money">$6000</div>
        </div>
        
        <!-- æ—¶é’Ÿ -->
        <div class="stat-card border-t-2 border-blue-500">
            <div class="text-xl font-mono leading-none text-white" id="ui-clock">00:00</div>
            <div class="flex justify-between w-full px-1 mt-1">
                <span class="text-[9px] text-gray-400" id="ui-day">D1</span>
                <span class="text-[9px] text-yellow-400" id="ui-speed">PAUSED</span>
            </div>
        </div>

        <!-- ç§Ÿé‡‘å€’è®¡æ—¶ -->
        <div class="stat-card border-t-2 border-red-500 bg-red-900/20">
            <span class="text-[10px] text-red-300">è·ç¦»ç»“ç®—</span>
            <div class="text-lg font-bold text-red-400" id="ui-rent-countdown">6å¤©</div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç”»é¢ -->
    <div class="relative w-full mb-2">
        <!-- æ‚¬æµ®ç›‘æ§æ¿ -->
        <div class="absolute top-2 left-2 bg-slate-900/80 backdrop-blur-sm p-2 rounded border border-slate-700 z-10 text-xs w-48 shadow-lg">
            <div class="flex justify-between mb-1 items-center">
                <span class="text-gray-400">è´Ÿè½½ Load</span>
                <span class="font-bold text-white" id="ui-load-text">0/150 kW</span>
            </div>
            <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden mb-2">
                <div id="ui-load-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[9px] text-gray-500 mb-0.5">
                <span class="text-yellow-500">å…‰ä¼</span>
                <span class="text-green-500">ç”µæ± </span>
                <span class="text-red-500">ç”µç½‘</span>
            </div>
            <div class="power-bar-bg mb-1">
                <div id="bar-solar" class="power-bar-seg bg-yellow-500" style="width:0%"></div>
                <div id="bar-batt" class="power-bar-seg bg-green-500" style="width:0%"></div>
                <div id="bar-grid" class="power-bar-seg bg-red-500" style="width:0%"></div>
            </div>
        </div>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <div id="fx-container" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="w-full bg-slate-800 p-3 rounded-t-xl border-t border-slate-700 flex-1 flex flex-col gap-3 shadow-2xl">
        
        <!-- é€Ÿåº¦ä¸ç”µä»· -->
        <div class="flex justify-between items-center border-b border-slate-700 pb-2">
            <div class="flex items-center gap-3">
                <button id="pause-btn" onclick="togglePause()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-500 shadow text-sm border border-blue-400">
                    â–¶ å¼€å§‹
                </button>
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400">ç”µç½‘æˆæœ¬ä»·</span>
                    <span id="ui-grid-price" class="font-mono font-bold text-lg text-white">$0.40</span>
                </div>
            </div>
            <div class="flex gap-1 bg-slate-900 p-1 rounded">
                 <button onclick="setSpeed(200)" class="speed-btn btn px-2 py-1 bg-slate-700 text-gray-300 rounded text-xs font-bold w-8" id="speed-1">1x</button>
                 <button onclick="setSpeed(40)" class="speed-btn btn px-2 py-1 bg-slate-700 text-gray-300 rounded text-xs font-bold w-8" id="speed-5">5x</button>
                 <button onclick="setSpeed(20)" class="speed-btn btn px-2 py-1 bg-slate-700 text-gray-300 rounded text-xs font-bold w-8" id="speed-10">10x</button>
                 <button onclick="setSpeed(10)" class="speed-btn btn px-2 py-1 bg-slate-700 text-gray-300 rounded text-xs font-bold w-8" id="speed-20">20x</button>
            </div>
        </div>

        <!-- èµ„äº§è´­ä¹° -->
        <div class="grid grid-cols-5 gap-1">
            <button onclick="buyAsset('slowCharger')" class="btn bg-blue-900/40 border-blue-800 text-blue-200 rounded h-16 flex flex-col items-center justify-center">
                <span class="font-bold text-[10px]">æ…¢å……</span>
                <span class="text-[9px] opacity-70">$3k</span>
                <span class="text-[9px] bg-blue-900 px-1 rounded mt-0.5" id="count-slow">0</span>
            </button>
            <button onclick="buyAsset('fastCharger')" class="btn bg-purple-900/40 border-purple-800 text-purple-200 rounded h-16 flex flex-col items-center justify-center">
                <span class="font-bold text-[10px]">å¿«å……</span>
                <span class="text-[9px] opacity-70">$15k</span>
                <span class="text-[9px] bg-purple-900 px-1 rounded mt-0.5" id="count-fast">0</span>
            </button>
            <button onclick="buyAsset('transformer')" class="btn bg-gray-700 border-gray-600 text-gray-200 rounded h-16 flex flex-col items-center justify-center">
                <span class="font-bold text-[10px]">é…ç”µ</span>
                <span class="text-[9px] opacity-70">$5k</span>
                <span class="text-[9px] bg-gray-800 px-1 rounded mt-0.5" id="count-transformer">0</span>
            </button>
            <button onclick="buyAsset('solar')" class="btn bg-yellow-900/40 border-yellow-800 text-yellow-200 rounded h-16 flex flex-col items-center justify-center">
                <span class="font-bold text-[10px]">å…‰ä¼</span>
                <span class="text-[9px] opacity-70">$8k</span>
                <span class="text-[9px] bg-yellow-900 px-1 rounded mt-0.5" id="count-solar">0</span>
            </button>
            <button onclick="buyAsset('battery')" class="btn bg-green-900/40 border-green-800 text-green-200 rounded h-16 flex flex-col items-center justify-center">
                <span class="font-bold text-[10px]">å‚¨èƒ½</span>
                <span class="text-[9px] opacity-70">$12k</span>
                <span class="text-[9px] bg-green-900 px-1 rounded mt-0.5" id="count-battery">0</span>
            </button>
        </div>

        <!-- å®šä»·æ»‘å— -->
        <div class="bg-slate-700 p-2 rounded border border-slate-600">
            <div class="flex justify-between mb-1">
                <label class="text-xs font-bold text-gray-300">æ‚¨çš„å®šä»· ($/åº¦)</label>
                <div class="flex items-center gap-2">
                    <span id="price-display" class="font-bold text-blue-400 text-lg">$1.20</span>
                </div>
            </div>
            <input type="range" id="price-slider" min="0.5" max="4.0" step="0.1" value="1.2" class="w-full h-2 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="updatePrice(this.value)">
            <p class="text-[9px] text-gray-400 mt-1 text-center">ä»·æ ¼è¶Šé«˜ï¼Œå®¢æµæ¦‚ç‡è¶Šä½ï¼Œä½†ä»æœ‰å‡ ç‡å‡ºç°ã€‚</p>
        </div>
    </div>

    <!-- äº‹ä»¶å¼¹çª— -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-6 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg border border-slate-600 text-center w-full max-w-sm shadow-2xl modal-enter relative">
            <div class="text-5xl mb-3" id="ev-icon">ğŸ“«</div>
            <h2 class="text-xl font-bold mb-2 text-white" id="ev-title">å‘¨ç»“ç®—</h2>
            
            <div class="bg-slate-900 p-3 rounded mb-3 text-left text-sm space-y-2">
                <div class="flex justify-between text-gray-400">
                    <span>åŸºç¡€ç»´æŠ¤è´¹:</span>
                    <span class="text-red-400 font-mono" id="ev-rent">-$1000</span>
                </div>
                <div class="border-t border-slate-700 my-2"></div>
                <div class="mb-1 text-yellow-500 font-bold" id="ev-event-name">éšæœºäº‹ä»¶</div>
                <div class="text-xs text-gray-300 mb-1" id="ev-event-desc">...</div>
                <div class="flex justify-between font-bold">
                    <span>äº‹ä»¶å½±å“:</span>
                    <span class="font-mono" id="ev-event-amt">+$0</span>
                </div>
            </div>

            <div class="flex justify-between items-center bg-slate-700 p-2 rounded mb-4">
                <span class="text-sm text-white">æ€»ç»“ç®—:</span>
                <span class="text-xl font-bold font-mono" id="ev-total">-$0</span>
            </div>
            
            <button onclick="closeEventModal()" class="w-full py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded transition border-t border-blue-500">
                ç¡®è®¤
            </button>
        </div>
    </div>

    <!-- ç ´äº§å¼¹çª— -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black flex items-center justify-center z-50 p-6">
        <div class="text-center text-white w-full max-w-md">
            <h1 class="text-5xl font-bold text-red-600 mb-2">ç ´äº§!</h1>
            <p class="text-gray-400 mb-6 text-sm">èµ„é‡‘å½’é›¶ã€‚åœ¨æ®‹é…·çš„å•†ä¸šä¸–ç•Œé‡Œï¼Œæ²¡æœ‰è´Ÿå€ºç»è¥çš„æœºä¼šã€‚</p>
            
            <div class="bg-gray-900 p-4 rounded-lg mb-8 border border-gray-800">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-gray-500">å­˜æ´»æ—¶é—´</div>
                        <div class="text-2xl font-bold text-white"><span id="final-days">0</span> å¤©</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">æœ€ç»ˆèµ„äº§</div>
                        <div class="text-2xl font-bold text-red-500">$0</div>
                    </div>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full py-3 bg-white text-black font-bold hover:bg-gray-200 transition rounded">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

<script>
/**
 * å¹³è¡¡ç‰ˆé…ç½® (V2)
 */
const CONFIG = {
    initialMoney: 6000,
    dailyOpCost: 150, 
    
    // ç§Ÿé‡‘ä½“ç³» (æ¸©å’Œé€šèƒ€)
    baseRent: 1000, 
    inflationRate: 0.08, // æ¯å‘¨æ¶¨8% (ä¹‹å‰æ˜¯15%)
    rentPerAsset: {
        slowCharger: 100, fastCharger: 500, solar: 200, battery: 300, transformer: 200
    },
    
    // è´­ä¹°æˆæœ¬
    costs: { 
        slowCharger: 3000, fastCharger: 15000, solar: 8000, battery: 12000, transformer: 5000 
    },
    
    // èƒ½æºå‚æ•°
    batteryCap: 200, batteryRate: 100, solarMax: 30, 
    baseLoadLimit: 150, transformerBoost: 300,

    // ç”µç½‘ä»·æ ¼ (0-23)
    gridPrices: [
        0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.4, 
        0.8, 1.2, 1.5, 1.5, 1.2, 0.8, 0.8, 
        1.0, 1.2, 1.8, 1.8, 1.5, 1.0, 0.8, 
        0.6, 0.5, 0.4                     
    ],
    
    // å®¢æµæ¦‚ç‡åŸºå‡†
    trafficCurve: [
        0.05, 0.05, 0.05, 0.05, 0.1, 0.2, 0.4, 
        0.8, 0.9, 0.8, 0.7, 0.6, 0.6, 0.6, 
        0.7, 0.9, 1.0, 1.0, 0.9, 0.7, 0.5, 
        0.3, 0.2, 0.1
    ],
    
    // å®¢æµæ± 
    baseDailyPool: 35, // ç¨å¾®å¢åŠ ä¸€ç‚¹
    poolGrowth: 3,
    poolCap: 200
};

let state = {
    money: CONFIG.initialMoney, day: 1, hour: 0, minute: 0,
    paused: true, gameSpeed: 200,
    
    assets: { slowCharger: 2, fastCharger: 0, solar: 0, battery: 0, transformer: 0 },
    batteryKwh: 0,
    price: 1.2, 
    
    dailyPoolMax: CONFIG.baseDailyPool,
    dailyPoolLeft: CONFIG.baseDailyPool,
    
    cars: [],
    lastTickData: { load: 0, solar: 0, batt: 0, grid: 0, limit: 150, battAction: '' },
    timer: null,
    weeksSurvived: 0
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- ç ´äº§æ£€æŸ¥ ---
function checkBankruptcy() {
    if (state.money < 0) {
        state.paused = true;
        clearTimeout(state.timer);
        document.getElementById('final-days').innerText = state.day;
        document.getElementById('game-over-modal').classList.remove('hidden');
        return true;
    }
    return false;
}

// --- é€»è¾‘å¾ªç¯ ---
function tick() {
    if (state.paused) return;

    state.minute += 10;
    if (state.minute >= 60) {
        state.minute = 0;
        state.hour++;
        if (state.hour >= 24) {
            state.hour = 0;
            dailySettle();
            if (checkBankruptcy()) return;
        }
    }

    const gridPrice = CONFIG.gridPrices[state.hour];
    const trafficProb = CONFIG.trafficCurve[state.hour];
    
    trySpawnCar(trafficProb, gridPrice);
    processEnergy(gridPrice);

    if (checkBankruptcy()) return;

    state.cars = state.cars.filter(c => {
        c.ticksLeft--;
        return c.ticksLeft > 0;
    });

    updateUI();
    state.timer = setTimeout(tick, state.gameSpeed);
}

// æ ¸å¿ƒï¼šæ¦‚ç‡å®šä»· (Soft Cap)
function trySpawnCar(baseProb, gridPrice) {
    if (state.dailyPoolLeft <= 0) return;
    if (Math.random() > baseProb) return;

    // é¡¾å®¢åŸºç¡€å¿ƒç†ä»·ä½ (çº¦ä¸ºç”µç½‘ä»·çš„ 1.5å€ ~ 2.0å€)
    // è¶…è¿‡è¿™ä¸ªä»·æ ¼ï¼Œæ¦‚ç‡å‘ˆæŒ‡æ•°è¡°å‡
    const fairPrice = gridPrice * 1.5 + 0.3; 
    const myPrice = state.price;
    const diff = myPrice - fairPrice;
    
    let acceptChance = 1.0;
    
    if (diff > 0) {
        // ä»·æ ¼é«˜ï¼šæ¦‚ç‡è¡°å‡
        // e.g., è´µ $0.5 -> chance ~0.6; è´µ $1.0 -> chance ~0.36
        acceptChance = Math.exp(-diff * 1.5); 
    } else {
        // ä»·æ ¼ä½ï¼šæ¦‚ç‡å¢åŠ  (ç¨å¾®å¢åŠ )
        acceptChance = Math.min(1.5, 1.0 + Math.abs(diff));
    }

    // æœ€å°ä¿åº•æ¦‚ç‡ 1% (æ€»æœ‰åœŸè±ªä¸çœ‹ä»·æ ¼)
    acceptChance = Math.max(0.01, acceptChance);

    if (Math.random() > acceptChance) return; // å«Œè´µèµ°äº†

    // ç”Ÿæˆç±»å‹
    const wantFast = Math.random() < 0.3; // 30% æƒ³å¿«å……
    let spawnType = null;
    let slot = -1;

    if (wantFast) {
        slot = findFreeSlot('fast');
        if (slot !== -1) spawnType = 'fast';
        // å¦‚æœæƒ³å¿«å……æ²¡ä½ç½®ï¼Œ50%æ¦‚ç‡æ¥å—æ…¢å……
        else if (Math.random() < 0.5) {
            slot = findFreeSlot('slow');
            if (slot !== -1) spawnType = 'slow';
        }
    } else {
        slot = findFreeSlot('slow');
        if (slot !== -1) spawnType = 'slow';
    }

    if (spawnType && slot !== -1) {
        state.dailyPoolLeft--;
        // æ…¢å……åœä¹…ä¸€ç‚¹ (2-6h)ï¼Œå¿«å…… (30-60m)
        const duration = spawnType === 'slow' ? (12 + Math.floor(Math.random()*24)) : (3 + Math.floor(Math.random()*3));
        // æ…¢å…… 30-40kwh, å¿«å…… 40-60kwh
        const kwh = spawnType === 'slow' ? (30+Math.random()*10) : (40+Math.random()*20);
        
        state.cars.push({
            type: spawnType, slot: slot, ticksLeft: duration,
            kwhTotal: kwh, kwhPerTick: kwh / duration,
            color: spawnType === 'slow' ? '#3b82f6' : '#a855f7',
            isCharging: false
        });
    }
}

function findFreeSlot(type) {
    const limit = state.assets[type + 'Charger'];
    for(let i=0; i<limit; i++) {
        if (!state.cars.some(c => c.type === type && c.slot === i)) return i;
    }
    return -1;
}

function processEnergy(gridPrice) {
    // è´Ÿè½½é€»è¾‘
    let reqLoad = 0; state.cars.forEach(c => reqLoad += c.kwhPerTick);
    
    const limitKw = CONFIG.baseLoadLimit + (state.assets.transformer * CONFIG.transformerBoost);
    const reqKw = reqLoad * 6;
    
    let throttle = 1.0;
    if (reqKw > limitKw) {
        throttle = limitKw / reqKw;
        if (state.gameSpeed >= 40 && Math.random() < 0.1) spawnFloatText("âš ï¸ è¿‡è½½", "#ef4444");
    }
    const actKwh = reqLoad * throttle;

    // èƒ½æºæµ
    let sunH = (state.hour >= 6 && state.hour <= 18) ? Math.sin((state.hour-6)/12*Math.PI) : 0;
    const solarKwh = state.assets.solar * CONFIG.solarMax * sunH * (0.5+Math.random()*0.5);

    let remain = actKwh;
    
    // Solar -> Load
    let usedSolar = Math.min(remain, solarKwh);
    remain -= usedSolar;
    let unusedSolar = solarKwh - usedSolar;

    // Solar -> Battery
    const batMax = state.assets.battery * CONFIG.batteryCap;
    if (unusedSolar > 0 && state.batteryKwh < batMax) {
        state.batteryKwh += Math.min(unusedSolar, batMax - state.batteryKwh);
    }

    // Battery Logic (Arbitrage)
    let usedBatt = 0;
    let gridCharge = 0;
    let battAct = 'idle';
    const batRate = state.assets.battery * CONFIG.batteryRate;

    // < 0.5 å……ç”µ
    if (gridPrice <= 0.5 && state.batteryKwh < batMax) {
        const amt = Math.min(batMax - state.batteryKwh, batRate);
        state.batteryKwh += amt;
        gridCharge = amt;
        battAct = 'charging';
    } 
    // > 0.6 æ”¾ç”µ
    else if (gridPrice > 0.6 && state.batteryKwh > 0 && remain > 0) {
        const amt = Math.min(state.batteryKwh, batRate, remain);
        state.batteryKwh -= amt;
        remain -= amt;
        usedBatt = amt;
        battAct = 'discharging';
    }

    let usedGrid = remain + gridCharge;

    // è´¢åŠ¡
    const revenue = actKwh * state.price;
    const cost = usedGrid * gridPrice;
    const profit = revenue - cost;

    state.money += profit;
    // ç ´äº§æ£€æŸ¥ç”±ä¸»å¾ªç¯å¤„ç†

    state.lastTickData = {
        load: reqKw, limit: limitKw,
        solar: usedSolar*6, batt: usedBatt*6, grid: usedGrid*6,
        battAction: battAct
    };

    // é£˜å­—
    if (state.gameSpeed >= 40 && profit !== 0 && state.minute % 30 === 0) {
        const col = profit > 0 ? '#4ade80' : '#f87171';
        const txt = profit > 0 ? `+${profit.toFixed(0)}` : `${Math.floor(profit)}`;
        spawnFloatText(txt, col);
    }
}

// éšæœºäº‹ä»¶ (æ­£è´Ÿçš†æœ‰ï¼Œé‡‘é¢é™åˆ¶)
function generateEvent() {
    const isBad = Math.random() < 0.6; // 60% åäº‹ï¼Œ40% å¥½äº‹
    let amount = 0;
    
    // è®¡ç®—é‡‘é¢èŒƒå›´: $500 ~ 20% of Current Money
    const maxImpact = Math.max(500, state.money * 0.2); 
    const minImpact = 500;
    const rawAmount = Math.floor(minImpact + Math.random() * (maxImpact - minImpact));
    
    // å¦‚æœè¿˜æ²¡é’±æ‰£ï¼Œå°±æŒ‰æœ€å°å€¼æ‰£ (ä¼šå¯¼è‡´ç ´äº§)
    amount = rawAmount;
    
    const badEvents = [
        { t: "è®¾å¤‡æ•…éšœ", d: "å˜å‹å™¨ç»„è¿‡çƒ­ç†”æ–­", i: "ğŸ”¥" },
        { t: "ç›‘ç®¡ç½šæ¬¾", d: "æ¶ˆé˜²æ£€æŸ¥æœªé€šè¿‡", i: "ğŸ‘®" },
        { t: "ç”µç½‘æ•…éšœ", d: "ç”±äºç”µç½‘æ³¢åŠ¨å¯¼è‡´è®¾å¤‡å—æŸ", i: "âš¡" },
        { t: "æ¶æ„ç«äº‰", d: "å¯¹æ‰‹é›‡äººç ´åå……ç”µæ¡©", i: "ğŸ”ª" }
    ];
    const goodEvents = [
        { t: "æ”¿åºœè¡¥è´´", d: "è·å¾—æ–°èƒ½æºè¿è¥è¡¥è´´", i: "ğŸ’°" },
        { t: "æŠ€æœ¯çªç ´", d: "ç”µæ± ç»´æŠ¤ä¼˜åŒ–ï¼Œè¿”è¿˜æˆæœ¬", i: "ğŸ”¬" },
        { t: "ç”µç½‘é€€ç¨", d: "å¹´åº¦ç”¨ç”µå¤§æˆ·é€€ç¨", i: "ğŸ§¾" }
    ];

    const pool = isBad ? badEvents : goodEvents;
    const ev = pool[Math.floor(Math.random() * pool.length)];
    
    return {
        title: ev.t,
        desc: ev.d,
        icon: ev.i,
        amount: isBad ? -amount : amount
    };
}

function dailySettle() {
    state.day++;
    state.money -= CONFIG.dailyOpCost;
    
    // å¢é•¿å®¢æµ
    state.dailyPoolMax = Math.min(CONFIG.poolCap, state.dailyPoolMax + CONFIG.poolGrowth);
    state.dailyPoolLeft = state.dailyPoolMax;

    // æ¯å‘¨ç»“ç®—
    if ((state.day - 1) % 7 === 0) {
        state.weeksSurvived++;
        
        // 1. è®¡ç®—ç§Ÿé‡‘
        let rent = CONFIG.baseRent;
        ['slow','fast','solar','battery','transformer'].forEach(k => {
            rent += state.assets[k] * CONFIG.rentPerAsset[k]; // ä¿®æ­£ assets å–å€¼ key
            if (k.endsWith('Charger')) rent += state.assets[k] * CONFIG.rentPerAsset[k.replace('Charger','')];
        });
        // ä¿®æ­£é€»è¾‘ï¼šä¸Šé¢ assets key å¯èƒ½æ··ä¹±ï¼Œé‡å†™
        rent = CONFIG.baseRent 
             + state.assets.slowCharger * CONFIG.rentPerAsset.slowCharger
             + state.assets.fastCharger * CONFIG.rentPerAsset.fastCharger
             + state.assets.solar * CONFIG.rentPerAsset.solar
             + state.assets.battery * CONFIG.rentPerAsset.battery
             + state.assets.transformer * CONFIG.rentPerAsset.transformer;

        rent = Math.floor(rent * Math.pow(1 + CONFIG.inflationRate, state.weeksSurvived));
        
        // 2. ç”Ÿæˆäº‹ä»¶
        const event = generateEvent();
        
        // 3. ç»“ç®—æ€»é¢
        const totalDelta = -rent + event.amount;
        state.money += totalDelta;
        
        // æš‚åœå¹¶æ˜¾ç¤º
        state.paused = true;
        updateUI(); // åˆ·æ–°æš‚åœçŠ¶æ€
        
        showEventModal(event, rent, totalDelta);
    }
}

// --- UI Logic ---
function togglePause() {
    state.paused = !state.paused;
    const btn = document.getElementById('pause-btn');
    const label = document.getElementById('ui-speed');
    if (state.paused) {
        btn.classList.add('bg-blue-600');
        btn.classList.remove('bg-gray-700');
        btn.innerText = "â–¶ ç»§ç»­";
        label.innerText = "PAUSED";
        label.className = "text-[9px] text-yellow-400 animate-pulse";
        clearTimeout(state.timer);
    } else {
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-gray-700');
        btn.innerText = "â¸ æš‚åœ";
        label.innerText = state.gameSpeed <= 20 ? ">>> MAX" : "> PLAY";
        label.className = "text-[9px] text-green-400";
        tick(); 
    }
}

function setSpeed(ms) {
    state.gameSpeed = ms;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('text-white', 'bg-slate-600'));
    let id = 'speed-1';
    if(ms===40) id='speed-5'; if(ms===20) id='speed-10'; if(ms===10) id='speed-20';
    document.getElementById(id).classList.add('text-white', 'bg-slate-600');
}

function buyAsset(type) {
    const cost = CONFIG.costs[type];
    if(state.money >= cost) {
        state.money -= cost;
        state.assets[type]++;
        spawnFloatText(`è´­ä¹° -$${cost}`, '#3b82f6');
        updateUI();
        checkBankruptcy();
    } else {
        spawnFloatText('èµ„é‡‘ä¸è¶³', '#ef4444');
    }
}

function updatePrice(val) {
    state.price = parseFloat(val);
    document.getElementById('price-display').innerText = `$${state.price.toFixed(2)}`;
}

function showEventModal(ev, rent, total) {
    const modal = document.getElementById('event-modal');
    document.getElementById('ev-icon').innerText = ev.icon;
    document.getElementById('ev-event-name').innerText = ev.title;
    document.getElementById('ev-event-name').className = ev.amount > 0 ? "mb-1 text-green-400 font-bold" : "mb-1 text-red-400 font-bold";
    document.getElementById('ev-event-desc').innerText = ev.desc;
    
    document.getElementById('ev-rent').innerText = `-$${rent}`;
    document.getElementById('ev-event-amt').innerText = (ev.amount > 0 ? "+" : "") + `$${ev.amount}`;
    document.getElementById('ev-event-amt').className = ev.amount > 0 ? "font-mono text-green-400" : "font-mono text-red-400";
    
    document.getElementById('ev-total').innerText = (total > 0 ? "+" : "") + `$${total}`;
    document.getElementById('ev-total').className = total > 0 ? "text-xl font-bold font-mono text-green-400" : "text-xl font-bold font-mono text-red-400";

    modal.classList.remove('hidden');
}

function closeEventModal() {
    document.getElementById('event-modal').classList.add('hidden');
    checkBankruptcy(); // ç»“ç®—åå†æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœç ´äº§äº†ç›´æ¥å¼¹ç ´äº§æ¡†
    if (state.money >= 0) togglePause();
}

function spawnFloatText(txt, col) {
    const el = document.createElement('div');
    el.className = 'float-text';
    el.innerText = txt;
    el.style.color = col;
    el.style.left = (30+Math.random()*40)+'%';
    el.style.top = (40+Math.random()*20)+'%';
    document.getElementById('fx-container').appendChild(el);
    setTimeout(()=>el.remove(), 1500);
}

function updateUI() {
    document.getElementById('ui-money').innerText = `$${Math.floor(state.money)}`;
    
    const h = state.hour.toString().padStart(2,'0');
    const m = state.minute.toString().padStart(2,'0');
    document.getElementById('ui-clock').innerText = `${h}:${m}`;
    document.getElementById('ui-day').innerText = `D${state.day}`;
    
    const daysLeft = 8 - ((state.day - 1) % 7 + 1);
    document.getElementById('ui-rent-countdown').innerText = daysLeft===1 ? "æ˜æ—¥!" : `${daysLeft}å¤©`;

    const gp = CONFIG.gridPrices[state.hour];
    const gpEl = document.getElementById('ui-grid-price');
    gpEl.innerText = `$${gp.toFixed(2)}`;
    gpEl.style.color = gp >= 1.5 ? '#f87171' : (gp <= 0.4 ? '#4ade80' : '#fff');

    const d = state.lastTickData;
    document.getElementById('ui-load-text').innerText = `${d.load.toFixed(0)}/${d.limit} kW`;
    const lp = Math.min(100, (d.load/d.limit)*100);
    const lb = document.getElementById('ui-load-bar');
    lb.style.width = `${lp}%`;
    lb.className = `h-full transition-all duration-300 ${d.load > d.limit ? 'bg-red-500' : 'bg-blue-500'}`;
    
    const tot = d.load || 1;
    document.getElementById('bar-solar').style.width = `${Math.min(100, d.solar/tot*100)}%`;
    document.getElementById('bar-batt').style.width = `${Math.min(100, d.batt/tot*100)}%`;
    document.getElementById('bar-grid').style.width = `${Math.min(100, d.grid/tot*100)}%`;

    ['slow','fast','solar','battery','transformer'].forEach(k => 
        document.getElementById(`count-${k}`).innerText = state.assets[k]
    );
}

// --- Draw ---
function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    const h = state.hour;
    
    let bg = '#1e293b'; 
    if(CONFIG.gridPrices[h] >= 1.5) {
        const g = ctx.createLinearGradient(0,0,0,520);
        g.addColorStop(0, '#450a0a'); 
        g.addColorStop(1, '#1e293b');
        ctx.fillStyle = g;
    } else {
        ctx.fillStyle = bg;
    }
    ctx.fillRect(0,0,800,520);

    drawHub(40, 20);
    drawChargers();
    requestAnimationFrame(draw);
}

function drawHub(x, y) {
    ctx.fillStyle = '#334155'; ctx.strokeStyle='#475569'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.roundRect(x, y, 220, 110, 8); ctx.fill(); ctx.stroke();

    const eff = (state.hour>=6 && state.hour<=18) ? Math.sin((state.hour-6)/12*Math.PI) : 0;
    ctx.fillStyle = '#facc15'; ctx.font='bold 12px sans-serif';
    ctx.fillText(`â˜€ï¸ å…‰ä¼ x${state.assets.solar}`, x+10, y+25);
    ctx.fillStyle = '#451a03'; ctx.fillRect(x+10, y+35, 80, 6);
    ctx.fillStyle = '#eab308'; ctx.fillRect(x+10, y+35, 80*eff, 6);

    const max = state.assets.battery * CONFIG.batteryCap;
    const pct = max>0 ? state.batteryKwh/max : 0;
    ctx.fillStyle = '#4ade80'; 
    ctx.fillText(`ğŸ”‹ å‚¨èƒ½ x${state.assets.battery}`, x+110, y+25);
    
    ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2;
    ctx.strokeRect(x+110, y+35, 50, 20); ctx.fillRect(x+162, y+40, 3, 10);
    ctx.fillStyle = pct<0.2 ? '#ef4444' : '#22c55e';
    ctx.fillRect(x+112, y+37, 46*pct, 16);

    const act = state.lastTickData.battAction;
    let txt = 'å¾…æœº', col = '#94a3b8';
    if(act==='charging') { txt='å¸ç­¹'; col='#4ade80'; }
    if(act==='discharging') { txt='å¥—åˆ©'; col='#f87171'; }
    ctx.fillStyle = col; ctx.font='10px sans-serif';
    ctx.fillText(txt, x+110, y+70);
    ctx.fillText(max>0 ? `${(pct*100).toFixed(0)}%` : '', x+140, y+70);

    if(state.assets.transformer>0) {
        ctx.fillStyle = '#94a3b8';
        ctx.fillText(`âš¡ å˜å‹å™¨ x${state.assets.transformer}`, x+10, y+90);
    }

    return {x: x+110, y: y+110};
}

function drawChargers() {
    let x=40, y=160, gap=90;
    
    const drawLine = (tx, ty) => {
        if(state.gameSpeed > 40) return;
        ctx.beginPath(); ctx.moveTo(150, 130); 
        ctx.bezierCurveTo(150, 180, tx+35, ty-50, tx+35, ty);
        ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth=1;
        ctx.stroke();
    };

    const render = (type, i) => {
        const car = state.cars.find(c=>c.type===type && c.slot===i);
        if(car && !state.paused) drawLine(x, y);
        
        ctx.fillStyle = '#1e293b'; ctx.strokeStyle='#334155';
        ctx.fillRect(x+10, y, 50, 80); ctx.strokeRect(x+10, y, 50, 80);
        
        ctx.fillStyle = type==='slow'?'#3b82f6':'#a855f7';
        ctx.font='10px sans-serif'; ctx.fillText(type==='slow'?'æ…¢':'å¿«', x+30, y-10);

        if(car) {
            ctx.fillStyle = car.color;
            ctx.fillRect(x, y+30, 70, 40);
            const p = 1 - (car.ticksLeft / (car.kwhTotal/car.kwhPerTick));
            ctx.fillStyle = '#166534'; ctx.fillRect(x+15, y+20, 40, 4);
            ctx.fillStyle = '#4ade80'; ctx.fillRect(x+15, y+20, 40*Math.max(0,p), 4);
        } else {
            ctx.fillStyle = '#475569'; ctx.font='10px sans-serif';
            ctx.fillText('ç©ºé—²', x+25, y+45);
        }
        
        x+=gap; if(x>700) { x=40; y+=100; }
    };

    for(let i=0; i<state.assets.slowCharger; i++) render('slow', i);
    for(let i=0; i<state.assets.fastCharger; i++) render('fast', i);
}

if(!ctx.roundRect) ctx.roundRect = function(x,y,w,h,r){this.rect(x,y,w,h);};

updateUI();
draw();
</script>
</body>
</html>

